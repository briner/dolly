#!/bin/bash
export DOLLY_MNT=backup

(
date

################
################
# DO NOT EDIT THIS PART: it is reserved to the sysadmin
rm -f /var/tmp/metadata4archive/zpool_status.out
rm -f /var/tmp/metadata4archive/zpool_list.out
rm -f /var/tmp/metadata4archive/beadm_list_-d.out
rm -f /var/tmp/metadata4archive/zfs_get_-rHp_all.out
rm -f /var/tmp/metadata4archive/zfs_list_-t_filesystem.out


(
echo "* include exclude generated for ${DOLLY_MNT}"
# exclude fs which are in both origin & clone from the original
echo "* exclude fs which are in both origin & clone from the original"
zfs get -H ch.unige.dolly:mountpoint | ggrep -P "\t/dolly/${DOLLY_MNT}\t" | cut -f1 |  grep -v @   \
 | gxargs --no-run-if-empty zfs get -H mounted | ggrep -P "\tyes\t" | cut -f1 \
 | gxargs --no-run-if-empty zfs get -H origin | cut -f3 | cut -d "@" -f1 \
 | gxargs --no-run-if-empty zfs get -H mountpoint | cut -f3 \
 | gsed 's|\(.*\)|exclude.fs \1|'

# exclude fs which are in other clone
echo "* exclude fs which are in other clone"
zfs get -H ch.unige:created_by | ggrep -P "\tdolly\t" | cut -f1 | grep -v @ \
 | gxargs --no-run-if-empty zfs get -H "ch.unige.dolly:mountpoint" | ggrep -Pv "\t/dolly/${DOLLY_MNT}\t" | cut -f1 \
 | gxargs --no-run-if-empty  zfs get -H mountpoint | cut -f3 \
 | gsed 's|\(.*\)|exclude.fs \1|'

) > /opt/tivoli/tsm/client/ba/bin/include_exclude_${DOLLY_MNT}

# UNTIL HERE
################
################

##
## edit here
## 

# start the service (eg:Database or other service)

##
## until here
##

) |& sed 's|^|dolly-post |' >> /var/log/dolly_hook  